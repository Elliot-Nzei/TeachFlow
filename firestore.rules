rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Rule for the top-level 'users' collection
    match /users/{userId} {
      // Allow any authenticated user to get or list users.
      // This is necessary for the user search functionality in data transfer.
      // It does NOT allow reading the content of all documents, only querying them.
      allow get, list: if request.auth != null;
    }

    // Rule for a user's own documents and subcollections
    match /users/{userId}/{documents=**} {
      // A user can read and write to their own data.
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Rule to allow creating an incoming transfer request for another user
    match /users/{recipientId}/incomingTransfers/{transferId} {
        // An authenticated user can create a transfer document for someone else.
        allow create: if request.auth != null;
    }
  }
}
