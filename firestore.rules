rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // A user can read and write to their own document and all of its subcollections.
    // This single recursive rule secures all user data (classes, students, grades, etc.)
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth.uid == userId;
    }

    // Allow an authenticated user to query the users collection ONLY if they are
    // looking for a specific user by their userCode. This is for the Data Transfer feature.
    match /users/{userId} {
        allow list: if request.auth != null && request.query.keys().hasAny(['where']) && request.query.where[0][0] == 'userCode';

        // Allow any authenticated user to create an incoming transfer for another user
        match /incomingTransfers/{transferId} {
            allow create: if request.auth != null;
        }
    }
  }
}
